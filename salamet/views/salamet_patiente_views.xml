<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vue formulaire patiente AM√âLIOR√âE -->
        <record id="view_salamet_patiente_form" model="ir.ui.view">
            <field name="name">salamet.patiente.form</field>
            <field name="model">salamet.patiente</field>
            <field name="arch" type="xml">
                <form string="Fiche Patiente SALAMET">
                    <header>
                        <!-- Boutons d'action rapide -->
                        <button name="action_nouvelle_grossesse" type="object"
                                string="Nouvelle Grossesse" class="btn-primary"
                                invisible="est_enceinte == True"/>
                        <button name="action_nouveau_bilan_prenatal" type="object"
                                string="Nouveau Bilan" class="btn-secondary"
                                invisible="est_enceinte == False"/>
                        <button name="action_generer_notifications" type="object"
                                string="G√©n√©rer Surveillance" class="btn-warning"
                                invisible="est_enceinte == False"/>
                    </header>

                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <!-- Smart buttons am√©lior√©s -->
                            <button name="action_view_grossesses" type="object"
                                    class="oe_stat_button" icon="fa-baby">
                                <field name="nombre_grossesses" widget="statinfo" string="Grossesses"/>
                            </button>
                            <button name="action_view_accouchements" type="object"
                                    class="oe_stat_button" icon="fa-heart">
                                <field name="nombre_accouchements" widget="statinfo" string="Accouchements"/>
                            </button>
                            <!-- Smart button pour le niveau de risque -->
                            <button class="oe_stat_button" icon="fa-exclamation-triangle">
                                <field name="niveau_risque_global" widget="statinfo" string="Niveau Risque"/>
                            </button>
                        </div>

                        <!-- En-t√™te avec badges de statut -->
                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Nom et pr√©nom de la patiente" required="1"/>
                            </h1>
                            <div class="o_row">
                                <span invisible="est_enceinte == False" class="badge badge-success">
                                    ü§∞ Enceinte
                                </span>
                                <span invisible="niveau_risque_global != 'tres_eleve'" class="badge badge-danger">
                                    ‚ö†Ô∏è Tr√®s haut risque
                                </span>
                                <span invisible="niveau_risque_global != 'eleve'" class="badge badge-warning">
                                    ‚ö†Ô∏è Haut risque
                                </span>
                                <!-- Badge sp√©cial pour consanguinit√© -->
                                <span invisible="consanguinite == False or degre_consanguinite != '1er'"
                                      class="badge badge-danger">
                                    üß¨ Consanguinit√© 1er degr√©
                                </span>
                                <span invisible="consanguinite == False or degre_consanguinite not in ['2eme', '3eme']"
                                      class="badge badge-warning">
                                    üß¨ Consanguinit√© <field name="degre_consanguinite"/>
                                </span>
                            </div>
                        </div>

                        <notebook>
                            <!-- ONGLET 1: INFORMATIONS PERSONNELLES -->
                            <page string="üë§ Informations Personnelles" name="personal_info">
                                <group>
                                    <group string="Patiente">
                                        <field name="date_naissance" required="1"/>
                                        <field name="age" readonly="1"/>
                                        <field name="profession"/>
                                        <field name="telephone" widget="phone"/>
                                                                                <field name="email" widget="email"/>
                                    </group>
                                    <group string="Conjoint">
                                        <field name="nom_mari"/>
                                        <field name="age_mari"/>
                                        <field name="profession_mari"/>
                                        <field name="telephone_mari" widget="phone"/>
                                        <field name="email_mari" widget="email"/>
                                    </group>
                                </group>

                                <group string="üìç Adresse">
                                    <field name="adresse" nolabel="1" placeholder="Adresse compl√®te..."/>
                                </group>
                            </page>

                            <!-- ONGLET 2: INFORMATIONS M√âDICALES -->
                            <page string="üè• Informations M√©dicales" name="medical_info">
                                <group>
                                    <group string="Donn√©es physiques">
                                        <field name="groupe_sanguin"/>
                                        <field name="poids"/>
                                        <field name="taille"/>
                                        <field name="imc" readonly="1"/>
                                    </group>
                                    <group string="GPA (Gestit√©-Parit√©-Avortements)">
                                        <field name="gestite"/>
                                        <field name="parite"/>
                                        <field name="avortements"/>
                                    </group>
                                </group>

                                <group string="üìù D√©tails GPA">
                                    <field name="gpa_details" nolabel="1"
                                           placeholder="D√©tails des grossesses ant√©rieures..."/>
                                </group>

                                <group string="üë®‚Äç‚öïÔ∏è √âquipe m√©dicale">
                                    <field name="medecin_ids" widget="many2many_tags"
                                           options="{'color_field': 'specialite', 'no_create': True}"/>
                                </group>
                            </page>

                            <!-- ONGLET 3: ANT√âC√âDENTS -->
                            <page string="üìã Ant√©c√©dents" name="antecedents">
                                <!-- Ant√©c√©dents familiaux -->
                                <group string="üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ant√©c√©dents familiaux">
                                    <group>
                                        <field name="antecedent_diabete_familial"/>
                                        <field name="age_survenue_diabete"
                                               invisible="antecedent_diabete_familial == False"/>
                                        <field name="antecedent_hta_familial"/>
                                        <field name="age_survenue_hta"
                                               invisible="antecedent_hta_familial == False"/>
                                    </group>
                                    <group>
                                        <!-- Section consanguinit√© am√©lior√©e -->
                                        <field name="consanguinite" widget="boolean_toggle"/>
                                        <field name="degre_consanguinite"
                                               invisible="consanguinite == False"
                                               required="consanguinite == True"/>
                                    </group>
                                </group>

                                <group string="üìù Autres ant√©c√©dents familiaux">
                                    <field name="autres_antecedents_familiaux" nolabel="1"
                                           placeholder="Autres ant√©c√©dents familiaux..."/>
                                </group>

                                <!-- Ant√©c√©dents personnels -->
                                <group string="üè• Ant√©c√©dents personnels" col="2">
                                    <group string="M√©dicaux">
                                        <field name="antecedents_medicaux" nolabel="1"
                                               placeholder="Ant√©c√©dents m√©dicaux..."/>
                                    </group>
                                    <group string="Chirurgicaux">
                                        <field name="antecedents_chirurgicaux" nolabel="1"
                                               placeholder="Ant√©c√©dents chirurgicaux..."/>
                                    </group>
                                </group>

                                <group string="ü§± Ant√©c√©dents gyn√©co-obst√©tricaux">
                                    <field name="antecedents_gyneco" nolabel="1"
                                           placeholder="Ant√©c√©dents gyn√©co-obst√©tricaux..."/>
                                </group>
                            </page>

                            <!-- ONGLET 4: √âVALUATION DES RISQUES -->
                            <page string="‚ö†Ô∏è √âvaluation des Risques" name="risk_assessment">
                                <group string="üìä Facteurs de risque automatiques" col="2">
                                    <group string="Facteurs calcul√©s">
                                        <field name="facteur_risque_age" readonly="1" widget="boolean_toggle"/>
                                        <field name="facteur_risque_imc" readonly="1" widget="boolean_toggle"/>
                                        <field name="facteur_risque_antecedents" readonly="1" widget="boolean_toggle"/>
                                        <field name="facteur_risque_consanguinite" readonly="1" widget="boolean_toggle"/>
                                    </group>
                                    <group string="Score et niveau">
                                        <field name="score_risque" readonly="1"/>
                                        <field name="niveau_risque_global" readonly="1" widget="badge"
                                               decoration-success="niveau_risque_global == 'faible'"
                                               decoration-info="niveau_risque_global == 'moyen'"
                                               decoration-warning="niveau_risque_global == 'eleve'"
                                               decoration-danger="niveau_risque_global == 'tres_eleve'"/>
                                    </group>
                                </group>

                                <group string="üìù Facteurs de risque suppl√©mentaires">
                                    <field name="facteurs_risque_supplementaires" nolabel="1"
                                           placeholder="Autres facteurs de risque identifi√©s (un par ligne)..."/>
                                </group>

                                <!-- Alerte sp√©ciale pour consanguinit√© -->
                                <div class="alert alert-danger" role="alert"
                                     invisible="consanguinite == False or degre_consanguinite != '1er'">
                                    <strong>‚ö†Ô∏è ATTENTION - Consanguinit√© 1er degr√© d√©tect√©e</strong><br/>
                                    Risque g√©n√©tique tr√®s √©lev√©. Conseil g√©n√©tique fortement recommand√©.
                                    Surveillance renforc√©e n√©cessaire pendant la grossesse.
                                </div>

                                <div class="alert alert-warning" role="alert"
                                     invisible="consanguinite == False or degre_consanguinite not in ['2eme', '3eme']">
                                    <strong>‚ö° Consanguinit√© d√©tect√©e</strong><br/>
                                    Risque g√©n√©tique mod√©r√© √† √©lev√©. Conseil g√©n√©tique recommand√©.
                                    Surveillance adapt√©e pendant la grossesse.
                                </div>
                            </page>

                            <!-- ONGLET 5: GROSSESSES -->
                            <page string="ü§∞ Grossesses" name="pregnancies">
                                <field name="grossesse_ids" mode="kanban">
                                    <kanban>
                                        <field name="name"/>
                                        <field name="ddr"/>
                                        <field name="tag"/>
                                        <field name="date_prevue_accouchement"/>
                                        <field name="state"/>
                                        <field name="type_pathologie_principale"/>
                                        <field name="niveau_risque"/>
                                        <field name="medecin_referent_id"/>
                                        <templates>
                                            <t t-name="kanban-box">
                                                <div class="oe_kanban_card oe_kanban_global_click">
                                                    <div class="oe_kanban_content">
                                                        <div class="o_kanban_record_top">
                                                            <div class="o_kanban_record_headings">
                                                                <strong class="o_kanban_record_title">
                                                                    <field name="name"/>
                                                                </strong>
                                                            </div>
                                                            <div class="o_kanban_record_top_right">
                                                                <span t-if="record.state.raw_value == 'en_cours'"
                                                                      class="badge badge-success">En cours</span>
                                                                <span t-if="record.state.raw_value == 'a_risque'"
                                                                      class="badge badge-warning">√Ä risque</span>
                                                                <span t-if="record.state.raw_value == 'terminee'"
                                                                      class="badge badge-secondary">Termin√©e</span>
                                                            </div>
                                                        </div>
                                                        <div class="o_kanban_record_body">
                                                            <div>üìÖ DDR: <field name="ddr"/></div>
                                                            <div>üçº DPA: <field name="date_prevue_accouchement"/></div>
                                                            <div t-if="record.tag.raw_value">
                                                                ‚è±Ô∏è TAG: <field name="tag"/> SA
                                                            </div>
                                                            <div>üè• <field name="type_pathologie_principale"/></div>
                                                            <div t-if="record.medecin_referent_id.raw_value">
                                                                üë®‚Äç‚öïÔ∏è <field name="medecin_referent_id"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </templates>
                                    </kanban>
                                </field>
                            </page>

                            <!-- ONGLET 6: BILANS PR√âNATAUX -->
                            <page string="üß™ Bilans Pr√©nataux" name="bilans">
                                <field name="bilan_prenatal_ids" mode="list">
                                    <list>
                                        <field name="date_bilan"/>
                                        <field name="terme_grossesse"/>
                                        <field name="type_bilan"/>
                                    </list>
                                </field>
                            </page>

                            <!-- ONGLET 7: ACCOUCHEMENTS -->
                            <page string="üë∂ Accouchements" name="deliveries">
                                <field name="accouchement_ids" mode="kanban">
                                    <kanban>
                                        <field name="name"/>
                                        <field name="date_accouchement"/>
                                        <field name="type_accouchement"/>
                                        <field name="poids_naissance"/>
                                        <field name="sexe_enfant"/>
                                        <templates>
                                            <t t-name="kanban-box">
                                                <div class="oe_kanban_card oe_kanban_global_click">
                                                    <div class="oe_kanban_content">
                                                        <div class="o_kanban_record_top">
                                                            <div class="o_kanban_record_headings">
                                                                <strong class="o_kanban_record_title">
                                                                    <field name="name"/>
                                                                </strong>
                                                            </div>
                                                            <div class="o_kanban_record_top_right">
                                                                <span t-if="record.type_accouchement.raw_value == 'naturel'"
                                                                      class="badge badge-success">Naturel</span>
                                                                <span t-if="record.type_accouchement.raw_value == 'cesarienne'"
                                                                      class="badge badge-info">C√©sarienne</span>
                                                            </div>
                                                        </div>
                                                        <div class="o_kanban_record_body">
                                                            <div>üìÖ <field name="date_accouchement"/></div>
                                                            <div t-if="record.sexe_enfant.raw_value">
                                                                <span t-if="record.sexe_enfant.raw_value == 'masculin'">üë∂</span>
                                                                <span t-if="record.sexe_enfant.raw_value == 'feminin'">üëß</span>
                                                                <field name="sexe_enfant"/>
                                                            </div>
                                                            <div t-if="record.poids_naissance.raw_value">
                                                                ‚öñÔ∏è <field name="poids_naissance"/> g
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </templates>
                                    </kanban>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Vue liste patientes AM√âLIOR√âE -->
        <record id="view_salamet_patiente_tree" model="ir.ui.view">
            <field name="name">salamet.patiente.tree</field>
            <field name="model">salamet.patiente</field>
            <field name="arch" type="xml">
                <list string="Patientes SALAMET"
                      decoration-success="est_enceinte == True"
                      decoration-warning="niveau_risque_global == 'eleve'"
                      decoration-danger="niveau_risque_global == 'tres_eleve'"
                      decoration-muted="active == False">
                    <field name="name"/>
                    <field name="age"/>
                    <field name="telephone" widget="phone"/>
                    <field name="groupe_sanguin"/>
                    <field name="gestite"/>
                    <field name="parite"/>
                    <field name="consanguinite" widget="boolean_toggle"/>
                    <field name="degre_consanguinite"
                           invisible="consanguinite == False"/>
                    <field name="est_enceinte" widget="boolean_toggle"/>
                    <field name="niveau_risque_global" widget="badge"
                           decoration-success="niveau_risque_global == 'faible'"
                           decoration-info="niveau_risque_global == 'moyen'"
                           decoration-warning="niveau_risque_global == 'eleve'"
                           decoration-danger="niveau_risque_global == 'tres_eleve'"/>
                    <field name="score_risque"/>
                    <field name="medecin_ids" widget="many2many_tags"/>
                    <field name="active" invisible="1"/>
                </list>
            </field>
        </record>

        <!-- Vue recherche AM√âLIOR√âE -->
        <record id="view_salamet_patiente_search" model="ir.ui.view">
            <field name="name">salamet.patiente.search</field>
            <field name="model">salamet.patiente</field>
            <field name="arch" type="xml">
                <search string="Rechercher Patientes">
                    <field name="name" string="Nom"/>
                    <field name="telephone" string="T√©l√©phone"/>
                    <field name="email" string="Email"/>
                    <field name="groupe_sanguin"/>
                    <field name="medecin_ids" string="M√©decin traitant"/>

                    <!-- Filtres principaux -->
                    <filter string="ü§∞ Enceintes" name="pregnant"
                            domain="[('est_enceinte', '=', True)]"/>
                    <filter string="‚ö†Ô∏è Haut risque" name="high_risk"
                            domain="[('niveau_risque_global', 'in', ['eleve', 'tres_eleve'])]"/>
                    <filter string="‚úÖ Actives" name="active"
                            domain="[('active', '=', True)]"/>

                    <separator/>

                    <!-- Filtres m√©dicaux -->
                    <filter string="ü©∏ Groupe O-" name="group_o_neg"
                            domain="[('groupe_sanguin', '=', 'O-')]"/>
                    <filter string="üß¨ Consanguinit√©" name="consanguinite"
                            domain="[('consanguinite', '=', True)]"/>
                    <filter string="üß¨ Consanguinit√© 1er degr√©" name="consanguinite_1er"
                            domain="[('consanguinite', '=', True), ('degre_consanguinite', '=', '1er')]"/>
                    <filter string="üß¨ Consanguinit√© 2√®me/3√®me degr√©" name="consanguinite_autres"
                            domain="[('consanguinite', '=', True), ('degre_consanguinite', 'in', ['2eme', '3eme'])]"/>
                    <filter string="üçØ Diab√®te familial" name="diabete_familial"
                            domain="[('antecedent_diabete_familial', '=', True)]"/>
                    <filter string="üíì HTA familiale" name="hta_familiale"
                            domain="[('antecedent_hta_familial', '=', True)]"/>

                    <separator/>

                    <!-- Filtres par score de risque -->
                    <filter string="Score risque ‚â• 3" name="score_high"
                            domain="[('score_risque', '>=', 3)]"/>
                    <filter string="Score risque ‚â• 5" name="score_very_high"
                            domain="[('score_risque', '>=', 5)]"/>

                    <group expand="0" string="Grouper par">
                        <filter string="Niveau de risque" name="group_by_risk"
                                context="{'group_by': 'niveau_risque_global'}"/>
                        <filter string="Consanguinit√©" name="group_by_consanguinite"
                                context="{'group_by': 'consanguinite'}"/>
                        <filter string="Degr√© de consanguinit√©" name="group_by_degre_consanguinite"
                                context="{'group_by': 'degre_consanguinite'}"/>
                        <filter string="Groupe sanguin" name="group_by_blood"
                                context="{'group_by': 'groupe_sanguin'}"/>
                        <filter string="M√©decin traitant" name="group_by_medecin"
                                context="{'group_by': 'medecin_ids'}"/>
                        <filter string="√âtat grossesse" name="group_by_pregnant"
                                context="{'group_by': 'est_enceinte'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Vue kanban pour patientes -->
        <record id="view_salamet_patiente_kanban" model="ir.ui.view">
            <field name="name">salamet.patiente.kanban</field>
            <field name="model">salamet.patiente</field>
            <field name="arch" type="xml">
                <kanban>
                    <field name="name"/>
                    <field name="age"/>
                    <field name="est_enceinte"/>
                    <field name="niveau_risque_global"/>
                    <field name="consanguinite"/>
                    <field name="degre_consanguinite"/>
                    <field name="score_risque"/>
                    <field name="telephone"/>
                    <field name="groupe_sanguin"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="name"/>
                                            </strong>
                                        </div>
                                        <div class="o_kanban_record_top_right">
                                            <span t-if="record.est_enceinte.raw_value" class="badge badge-success">
                                                ü§∞ Enceinte
                                            </span>
                                            <span t-if="record.niveau_risque_global.raw_value == 'tres_eleve'"
                                                  class="badge badge-danger">
                                                Tr√®s haut risque
                                            </span>
                                            <span t-if="record.niveau_risque_global.raw_value == 'eleve'"
                                                  class="badge badge-warning">
                                                Haut risque
                                            </span>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div>üë§ <field name="age"/> ans</div>
                                        <div t-if="record.telephone.raw_value">
                                            üìû <field name="telephone"/>
                                        </div>
                                        <div t-if="record.groupe_sanguin.raw_value">
                                            ü©∏ <field name="groupe_sanguin"/>
                                        </div>
                                        <div t-if="record.consanguinite.raw_value">
                                            üß¨ Consanguinit√© <field name="degre_consanguinite"/>
                                        </div>
                                        <div>üìä Score risque: <field name="score_risque"/></div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Action principale pour les patientes -->
        <record id="action_salamet_patiente" model="ir.actions.act_window">
            <field name="name">Patientes SALAMET</field>
            <field name="res_model">salamet.patiente</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Cr√©er une nouvelle patiente
                </p>
                <p>
                    Enregistrez les informations des patientes pour le suivi de grossesse SALAMET.
                </p>
            </field>
        </record>

        <!-- Action pour nouvelle patiente -->
        <record id="action_salamet_nouvelle_patiente" model="ir.actions.act_window">
            <field name="name">Nouvelle Patiente</field>
            <field name="res_model">salamet.patiente</field>
            <field name="view_mode">form</field>
            <field name="target">current</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Ajouter une nouvelle patiente
                </p>
                <p>
                    Enregistrez une nouvelle patiente dans le syst√®me.
                </p>
            </field>
        </record>

        <!-- Action pour patientes √† risque -->
        <record id="action_salamet_patiente_risque" model="ir.actions.act_window">
            <field name="name">Patientes √† Risque</field>
            <field name="res_model">salamet.patiente</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="domain">[('niveau_risque_global', 'in', ['eleve', 'tres_eleve'])]</field>
            <field name="context">{'search_default_high_risk': 1}</field>
        </record>

        <!-- Action pour patientes avec consanguinit√© -->
        <record id="action_salamet_patiente_consanguinite" model="ir.actions.act_window">
            <field name="name">Patientes avec Consanguinit√©</field>
            <field name="res_model">salamet.patiente</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="domain">[('consanguinite', '=', True)]</field>
            <field name="context">{'search_default_consanguinite': 1}</field>
        </record>

    </data>
</odoo>

